pipeline {
    agent any

    tools {
        jdk 'jdk17'
        nodejs 'node25'
    }

    environment {
        SCANNER = tool 'sonar-scanner'
        IMAGE   = "kastrov/zomato:latest"
        REPO    = "https://github.com/DevanshuALW/Zomato-Project-Kastro.git"
    }

    stages {

        stage("Init") {
            steps {
                cleanWs()
                git "${REPO}"
            }
        }

        stage("SonarQube (FAST)") {
            steps {
                withSonarQubeEnv('sonar-server') {
                    sh """
                        ${SCANNER}/bin/sonar-scanner \
                        -Dsonar.projectKey=zomato \
                        -Dsonar.projectName=zomato \
                        -Dsonar.sources=src \
                        -Dsonar.exclusions=node_modules/**,**/*.test.js \
                        -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
                    """
                }
            }
        }

        stage("Quality Gate") {
            steps {
                script {
                    waitForQualityGate abortPipeline: true, credentialsId: 'Sonar-token'
                }
            }
        }

        stage("Install Deps (Cached)") {
            steps {
                sh """
                    if [ ! -d node_modules ]; then
                        npm install
                    else
                        echo 'Using cached node_modules'
                    fi
                """
            }
        }

        stage("Security Scans (FAST PARALLEL)") {
            parallel {

                stage("OWASP FAST") {
                    steps {
                        // Scan ONLY package-lock.json (FASTEST MODE)
                        dependencyCheck additionalArguments: '--scan package-lock.json -n', odcInstallation: 'DP-Check'
                        dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
                    }
                }

                stage("Trivy Image Scan (Super Fast)") {
                    steps {
                        sh "docker build -t zomato ."
                        sh "trivy image --scanners vuln --quiet zomato > trivy.txt"
                    }
                }
            }
        }

        stage("Push to DockerHub") {
            steps {
                script {
                    withDockerRegistry(credentialsId: 'docker') {
                        sh """
                            docker tag zomato ${IMAGE}
                            docker push ${IMAGE}
                        """
                    }
                }
            }
        }

        stage("Docker Scout Quick Check") {
            steps {
                script {
                    withDockerRegistry(credentialsId: 'docker', toolName: 'docker') {
                        sh "docker-scout quickview ${IMAGE}"
                    }
                }
            }
        }

        stage("Deploy (Fast Restart)") {
            steps {
                sh """
                    docker rm -f zomato || true
                    docker run -d --name zomato -p 3000:3000 ${IMAGE}
                """
            }
        }
    }

    post {
        always {
            emailext attachLog: true,
                     subject: "'${currentBuild.result}' Zomato Pipeline",
                     to: "sdevanshu096@gmail.com",
                     mimeType: "text/html",
                     attachmentsPattern: "trivy.txt",
                     body: """
                        <h3>Build: ${env.BUILD_NUMBER}</h3>
                        <p>Project: ${env.JOB_NAME}</p>
                        <p>Status: ${currentBuild.result}</p>
                        <p>URL: ${env.BUILD_URL}</p>
                     """
        }
    }
}
